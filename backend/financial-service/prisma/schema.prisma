// üóÑÔ∏è Prisma Schema - Financial Service
// Documentation : https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client-financial"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üéØ ENUMS

enum UserRole {
  USER
  ADMIN
  PREMIUM
}

enum AccountType {
  PERSONAL
  SHARED
}

enum Currency {
  EUR
  USD
  GBP
  CAD
  AUD
  JPY
  CHF
  INR
  SGD
}

enum TransactionCategory {
  FOOD
  TRANSPORT
  HOUSING
  UTILITIES
  HEALTH
  ENTERTAINMENT
  SHOPPING
  EDUCATION
  SAVINGS
  INVESTMENT
  SALARY
  GIFT
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// üë§ USER - Utilisateur (synchronis√© depuis auth-service)
model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  name          String
  avatar        String?
  role          UserRole @default(USER)
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  ownedAccounts    Account[]         @relation("AccountOwner")
  accountMemberships AccountMember[]
  transactions     Transaction[]
  recurringTransactions RecurringTransaction[]

  @@map("users")
}

// üí∞ ACCOUNT - Compte financier (personnel ou partag√©)
model Account {
  id        Int         @id @default(autoincrement())
  name      String      // Ex: "Compte courant", "Budget vacances"
  type      AccountType
  balance   Decimal     @default(0) @db.Decimal(12, 2) // Solde actuel
  currency  Currency    @default(EUR)
  ownerId   Int         // Cr√©ateur du compte
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  owner        User              @relation("AccountOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members      AccountMember[]
  transactions Transaction[]
  recurringTransactions RecurringTransaction[]

  @@map("accounts")
}

// üë• ACCOUNT_MEMBER - Membre d'un compte partag√©
model AccountMember {
  id        Int      @id @default(autoincrement())
  accountId Int
  userId    Int
  role      String   @default("MEMBER") // OWNER ou MEMBER
  joinedAt  DateTime @default(now())

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@map("account_members")
}

// üí∏ TRANSACTION - Transaction financi√®re
model Transaction {
  id          Int                 @id @default(autoincrement())
  accountId   Int
  userId      Int                 // Utilisateur qui a cr√©√© la transaction
  amount      Decimal             @db.Decimal(12, 2)
  type        TransactionType
  category    TransactionCategory
  description String?
  date        DateTime            @default(now())
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId, date])
  @@map("transactions")
}

// üîÑ RECURRING_TRANSACTION - Transaction r√©currente
model RecurringTransaction {
  id          Int                  @id @default(autoincrement())
  accountId   Int
  userId      Int
  amount      Decimal              @db.Decimal(12, 2)
  type        TransactionType
  category    TransactionCategory
  description String?
  frequency   RecurrenceFrequency
  startDate   DateTime
  endDate     DateTime?            // Optionnel (null = ind√©fini)
  nextDate    DateTime             // Prochaine ex√©cution
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("recurring_transactions")
}
