# üê≥ Docker Compose Configuration - WeBudget Full Stack
# Ce fichier d√©finit tous les services pour d√©ploiement complet

version: '3.8'

services:
  # üóÑÔ∏è PostgreSQL - Base de donn√©es principale
  postgres:
    image: postgres:16-alpine
    container_name: webudget-postgres
    restart: unless-stopped
    ports:
      - '5432:5432'
    environment:
      POSTGRES_USER: webudget
      POSTGRES_PASSWORD: webudget_dev_2024
      POSTGRES_MULTIPLE_DATABASES: webudget_auth,webudget_financial,webudget_events,webudget_chat
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh
    networks:
      - webudget-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U webudget']
      interval: 10s
      timeout: 5s
      retries: 5

  # üîê Auth Service (Port 3001)
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    container_name: webudget-auth
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://webudget:webudget_dev_2024@postgres:5432/webudget_auth?schema=public
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-your-super-secret-jwt-access-key-change-in-production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-your-super-secret-jwt-refresh-key-change-in-production}
      PORT: 3001
      NODE_ENV: production
      CORS_ORIGIN: http://localhost:5173
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - webudget-network

  # üí∞ Financial Service (Port 3002)
  financial-service:
    build:
      context: ./backend/financial-service
      dockerfile: Dockerfile
    container_name: webudget-financial
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://webudget:webudget_dev_2024@postgres:5432/webudget_financial?schema=public
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-your-super-secret-jwt-access-key-change-in-production}
      PORT: 3002
      NODE_ENV: production
      CORS_ORIGIN: http://localhost:5173
    ports:
      - "3002:3002"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - webudget-network

  # üîî Events Service (Port 3003)
  events-service:
    build:
      context: ./backend/events-service
      dockerfile: Dockerfile
    container_name: webudget-events
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://webudget:webudget_dev_2024@postgres:5432/webudget_events?schema=public
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-your-super-secret-jwt-access-key-change-in-production}
      PORT: 3003
      NODE_ENV: production
      CORS_ORIGIN: http://localhost:5173
    ports:
      - "3003:3003"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - webudget-network

  # üí¨ Chat Service (Port 3004)
  chat-service:
    build:
      context: ./backend/chat-service
      dockerfile: Dockerfile
    container_name: webudget-chat
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://webudget:webudget_dev_2024@postgres:5432/webudget_chat?schema=public
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-your-super-secret-jwt-access-key-change-in-production}
      PORT: 3004
      NODE_ENV: production
      CORS_ORIGIN: http://localhost:5173
    ports:
      - "3004:3004"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - webudget-network

  # üé® Frontend (Vue 3)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: webudget-frontend
    restart: unless-stopped
    ports:
      - "5173:80"
    depends_on:
      - auth-service
      - financial-service
      - events-service
      - chat-service
    networks:
      - webudget-network

  # üåê Adminer - Interface DB
  adminer:
    image: adminer:latest
    container_name: webudget-adminer
    restart: unless-stopped
    ports:
      - '8080:8080'
    depends_on:
      - postgres
    networks:
      - webudget-network

# üì¶ Volumes persistants
volumes:
  postgres_data:
    driver: local

# üîó R√©seau
networks:
  webudget-network:
    driver: bridge
